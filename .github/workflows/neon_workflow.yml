name: Create/Delete Branch for Pull Request

# Note: This workflow is skipped for PRs from dev -> main
# GitHub Actions doesn't support filtering by head_ref in the on: section,
# so the exclusion is handled in the job conditions below 

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  setup:
    name: Setup
    # Skip this workflow for PRs from dev -> main
    if: github.base_ref != 'main' || github.head_ref != 'dev'
    outputs:
      branch: ${{ steps.branch_name.outputs.current_branch }}
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name
        id: branch_name
        uses: tj-actions/branch-names@v8

  create_neon_branch:
    name: Create Neon Branch
    outputs:
      # Output names from neondatabase/create-branch-action: https://github.com/neondatabase/create-branch-action 
      db_url: ${{ steps.create_neon_branch.outputs.db_url }}
      db_url_with_pooler: ${{ steps.create_neon_branch.outputs.db_url_pooled }}
    needs: setup
    if: |
      github.event_name == 'pull_request' && (
      github.event.action == 'synchronize'
      || github.event.action == 'opened'
      || github.event.action == 'reopened')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Get branch expiration date as an env variable (2 weeks from now)
        id: get_expiration_date
        run: echo "expires_at=$(date -u --date '+14 days' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"
      - name: Create Neon Branch
        id: create_neon_branch
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}
          expires_at: ${{ steps.get_expiration_date.outputs.expires_at }}
          branch_type: default # "default" - copies full data, or "schema-only" - only copies schema

      - name: Get Railway PR Environment ID
        id: get_railway_env
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_GHA_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          # Validate required environment variables
          if [ -z "$RAILWAY_API_TOKEN" ] || [ "$RAILWAY_API_TOKEN" == "null" ]; then
            echo "Error: RAILWAY_API_TOKEN is not set or is null"
            echo "Please ensure the RAILWAY_GHA_TOKEN secret is configured in your repository settings"
            exit 1
          fi

          if [ -z "$RAILWAY_PROJECT_ID" ] || [ "$RAILWAY_PROJECT_ID" == "null" ]; then
            echo "Error: RAILWAY_PROJECT_ID is not set or is null"
            echo "Please ensure the RAILWAY_PROJECT_ID variable is configured in your repository settings"
            exit 1
          fi

          # Retry logic: Railway PR environment may take a moment to be created
          MAX_ATTEMPTS=6
          SLEEP_SECONDS=10

          echo "Looking for Railway PR environment matching PR-$PR_NUMBER"
          echo "Expected pattern: portfolio-pr-$PR_NUMBER (or pr-$PR_NUMBER)"

          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo ""
            echo "Attempt $attempt of $MAX_ATTEMPTS to find Railway PR environment..."

            # Query Railway API for all environments in the project
            RESPONSE=$(curl -s --request POST \
              --url https://backboard.railway.com/graphql/v2 \
              --header "Authorization: Bearer $RAILWAY_API_TOKEN" \
              --header "Content-Type: application/json" \
              --data '{
                "query": "query { environments(projectId: \"'$RAILWAY_PROJECT_ID'\") { edges { node { name id } } } }"
              }')

            # Check for API errors
            if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
              echo "Error: Railway API returned errors:"
              echo "$RESPONSE" | jq -r '.errors[] | "  - \(.message)"'
              if [ $attempt -lt $MAX_ATTEMPTS ]; then
                echo "Waiting ${SLEEP_SECONDS}s before retry..."
                sleep $SLEEP_SECONDS
                continue
              else
                echo "Failed after $MAX_ATTEMPTS attempts due to API errors"
                exit 1
              fi
            fi

            # Display all available environments for debugging
            echo "Available environments:"
            echo "$RESPONSE" | jq -r '.data.environments.edges[] | "  - \(.node.name) (ID: \(.node.id))"'

            # Find the environment matching portfolio-pr-{number} or pr-{number} pattern
            # Railway PR environments are named "portfolio-pr-{number}" or "pr-{number}" (or with hash suffix)
            ENV_ID=$(echo "$RESPONSE" | jq -r '.data.environments.edges[] | select(.node.name | test("(^portfolio-pr-'$PR_NUMBER'($|-))|(^pr-'$PR_NUMBER'($|-))")) | .node.id' | head -1)
            ENV_NAME=$(echo "$RESPONSE" | jq -r '.data.environments.edges[] | select(.node.name | test("(^portfolio-pr-'$PR_NUMBER'($|-))|(^pr-'$PR_NUMBER'($|-))")) | .node.name' | head -1)

            if [ -n "$ENV_ID" ] && [ "$ENV_ID" != "null" ]; then
              echo ""
              echo "âœ“ Found Railway environment: $ENV_NAME (ID: $ENV_ID)"
              echo "env_id=$ENV_ID" >> "$GITHUB_OUTPUT"
              echo "RAILWAY_ENV_FOUND=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            if [ $attempt -lt $MAX_ATTEMPTS ]; then
              echo "Environment not found yet, waiting ${SLEEP_SECONDS}s before retry..."
              sleep $SLEEP_SECONDS
            fi
          done

          # If we get here, environment was not found after all attempts
          echo ""
          echo "Error: Could not find Railway environment for PR-$PR_NUMBER after $MAX_ATTEMPTS attempts"
          echo "Searched for patterns: portfolio-pr-$PR_NUMBER or pr-$PR_NUMBER"
          echo ""
          echo "Available environments:"
          echo "$RESPONSE" | jq -r '.data.environments.edges[] | "  - \(.node.name) (ID: \(.node.id))"'
          echo ""
          echo "Please ensure the Railway PR environment has been created for this pull request."
          exit 1

      - name: Update Railway DATABASE_URL Variables and Redeploy
        if: steps.get_railway_env.outputs.RAILWAY_ENV_FOUND == 'true'
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_GHA_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID }}
          RAILWAY_ENV_ID: ${{ steps.get_railway_env.outputs.env_id }}
          RAILWAY_FASTAPI_SERVICE_ID: ${{ vars.RAILWAY_FASTAPI_SERVICE_ID }}
          # Output names from neondatabase/create-branch-action: https://github.com/neondatabase/create-branch-action
          DB_URL_POOLED: ${{ steps.create_neon_branch.outputs.db_url_pooled }}
          DB_URL_UNPOOLED: ${{ steps.create_neon_branch.outputs.db_url }}
          INFORMATIONAL_NEON_BRANCH_NAME: pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
        run: |

          # fail if any of above environment variables are not set
          if [ -z "$RAILWAY_API_TOKEN" ] || [ -z "$RAILWAY_PROJECT_ID" ] || [ -z "$RAILWAY_ENV_ID" ] || [ -z "$RAILWAY_FASTAPI_SERVICE_ID" ] || [ -z "$DB_URL_POOLED" ] || [ -z "$DB_URL_UNPOOLED" ] || [ -z "$INFORMATIONAL_NEON_BRANCH_NAME" ]; then
            echo "Error: One or more environment variables are not set"
            # print all missing variables
            echo "Missing variables:"
            for var in RAILWAY_API_TOKEN RAILWAY_PROJECT_ID RAILWAY_ENV_ID RAILWAY_FASTAPI_SERVICE_ID DB_URL_POOLED DB_URL_UNPOOLED INFORMATIONAL_NEON_BRANCH_NAME; do
              if [ -z "${!var}" ]; then
                echo "  - $var"
              fi
            done
            exit 1
          fi

          # Update all Railway environment variables in a single GraphQL mutation
          QUERY=$(cat .github/queries/update_railway_variables.graphql)
          # Build JSON payload with proper escaping using jq variables support
          PAYLOAD=$(jq -n \
            --arg query "$QUERY" \
            --arg operationName "UpdateRailwayVariables" \
            --arg projectId "$RAILWAY_PROJECT_ID" \
            --arg environmentId "$RAILWAY_ENV_ID" \
            --arg serviceId "$RAILWAY_FASTAPI_SERVICE_ID" \
            --arg dbUrlPooled "$DB_URL_POOLED" \
            --arg dbUrlUnpooled "$DB_URL_UNPOOLED" \
            --arg neonBranchName "$INFORMATIONAL_NEON_BRANCH_NAME" \
            '{query: $query, operationName: $operationName, variables: {projectId: $projectId, environmentId: $environmentId, serviceId: $serviceId, dbUrlPooled: $dbUrlPooled, dbUrlUnpooled: $dbUrlUnpooled, neonBranchName: $neonBranchName}}')
          RESPONSE_FILE=$(mktemp)
          HTTP_CODE=$(curl -s -o "$RESPONSE_FILE" -w "%{http_code}" --request POST \
            --url https://backboard.railway.com/graphql/v2 \
            --header "Authorization: Bearer $RAILWAY_API_TOKEN" \
            --header "Content-Type: application/json" \
            --data "$PAYLOAD")
          RESPONSE=$(cat "$RESPONSE_FILE")
          rm "$RESPONSE_FILE"
          
          echo "Railway API response (HTTP $HTTP_CODE):"
          echo "$RESPONSE" | jq .
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: Failed to update Railway environment variables (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # check graphql level errors
          if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error: Railway API returned GraphQL errors when updating environment variables:"
            echo "$RESPONSE" | jq -r '.errors[] | "  - \(.message)"'
            exit 1
          fi

          echo "Updated DATABASE_URL, DATABASE_URL_UNPOOLED, and INFORMATIONAL_NEON_BRANCH_NAME for Railway environment"

          # Redeploy happens automatically
          echo "Redeploying Railway environment"

# The step above creates a new Neon branch.
# You may want to do something with the new branch, such as run migrations, run tests
# on it, or send the connection details to a hosting platform environment.
# The branch DATABASE_URL is available to you via:
# "${{ steps.create_neon_branch.outputs.db_url_with_pooler }}".
# It's important you don't log the DATABASE_URL as output as it contains a username and
# password for your database.
# For example, you can uncomment the lines below to run a database migration command:
#      - name: Run Migrations
#        run: npm run db:migrate
#        env:
#          # to use pooled connection
#          DATABASE_URL: "${{ steps.create_neon_branch.outputs.db_url_with_pooler }}"
#          # OR to use unpooled connection
#          # DATABASE_URL: "${{ steps.create_neon_branch.outputs.db_url }}"

# Following the step above, which runs database migrations, you may want to check
# for schema changes in your database. We recommend using the following action to
# post a comment to your pull request with the schema diff. For this action to work,
# you also need to give permissions to the workflow job to be able to post comments
# and read your repository contents. Add the following permissions to the workflow job:
#
# permissions:
#   contents: read
#   pull-requests: write
#
# You can also check out https://github.com/neondatabase/schema-diff-action for more
# information on how to use the schema diff action.
# You can uncomment the lines below to enable the schema diff action.
#      - name: Post Schema Diff Comment to PR
#        uses: neondatabase/schema-diff-action@v1
#        with:
#          project_id: ${{ vars.NEON_PROJECT_ID }}
#          compare_branch: pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
#          api_key: ${{ secrets.NEON_API_KEY }}

  delete_neon_branch:
    name: Delete Neon Branch
    needs: setup
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}