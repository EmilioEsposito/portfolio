services:
  postgres:
    image: postgres:17
    container_name: portfolio-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: portfolio
      POSTGRES_USER: portfolio
      POSTGRES_PASSWORD: portfolio
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - portfolio-net

  fastapi:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: portfolio-fastapi
    ports:
      - "8000:8000"
    # these are available on run time, but not on build time
    env_file:
      - .env
    # Override DATABASE_URL to use postgres service name instead of localhost when running in Docker
    # Also ensure DATABASE_REQUIRE_SSL is set to false for local postgres (which doesn't support SSL)
    environment:
      - DATABASE_URL=postgresql://portfolio:portfolio@postgres:5432/portfolio
      - DATABASE_URL_UNPOOLED=postgresql://portfolio:portfolio@postgres:5432/portfolio
      - DATABASE_REQUIRE_SSL=false
    networks:
      - portfolio-net
    depends_on:
      - postgres
  web-react-router:
    build:
      context: .
      dockerfile: apps/web-react-router/Dockerfile
    container_name: portfolio-web-react-router
    ports:
      - "5173:5173"
    env_file:
      - .env
    environment:
      - LOCAL_DOCKER_COMPOSE=true
    depends_on:
      - fastapi
      - postgres
    networks:
      - portfolio-net
  my-expo-app:
    build:
      context: .
      dockerfile: apps/my-expo-app/Dockerfile
    container_name: portfolio-expo
    ports:
      - "8081:8081"
    # Add env_file if Expo app needs runtime env vars from .env
    env_file:
      - .env 
    networks:
      - portfolio-net

networks:
  portfolio-net:
    driver: bridge

volumes:
  postgres-data:

